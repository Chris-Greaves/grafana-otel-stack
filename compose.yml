name: grafana-otel-stack

networks:
  azurite:

include:
  - path:
    - loki/compose.yml

services:
  grafana:
    image: grafana/grafana:10.2.2
    container_name: grafana
    ports:
      - 3000:3000
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=grafana
    volumes:
      - ./grafana:/etc/grafana/provisioning/datasources
      - grafana-data:/var/lib/grafana
    networks:
      - loki

  grafana-pencil:
    image: ghcr.io/chris-greaves/pencil:v0.0.3
    environment:
      - DEPLOYMENT_MODE=simple
      - AZURE_ENDPOINT=${AZURE_BLOB_ENDPOINT}
      - AZURE_STORAGE_ACCOUNT=${AZURE_STORAGE_ACCOUNT}
      - AZURE_STORAGE_KEY=${AZURE_STORAGE_KEY}
    command:
      - "/mnt/configs/"
      - "/mnt/create-containers.sh"
    volumes:
      - ./tempo/tempo.yml:/mnt/configs/tempo.yml
      - ./loki/loki.yml.gotmpl:/mnt/configs/loki.yml.gotmpl
      - ./loki/loki.yml:/mnt/configs/loki.yml
      - ./create-containers.sh:/mnt/create-containers.sh

  # Local Azure Storage
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    container_name: azurite
    ports:
      - 10000:10000
    networks:
      - azurite

  # Creates the Azure storage container
  azure-cli:
    image: mcr.microsoft.com/azure-cli
    command:
      - sh
      - -c
      - /etc/create-containers.sh
    volumes:
      - ./create-containers.sh:/etc/create-containers.sh
    networks:
      - azurite
    depends_on:
      azurite:
        condition: service_started
      grafana-pencil:
        condition: service_completed_successfully
volumes:
  grafana-data:
  prom_data:
  tempo_data:
